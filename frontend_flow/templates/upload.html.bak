{% extends 'base.html' %}
{% block content %}
<div class="hero-section">
  <h1 class="hero-title">Voice Insights from Buyer-Seller Conversations</h1>
  <p class="hero-subtitle">Upload audio calls or paste transcript to extract actionable business intelligence powered by AI</p>
</div>

<div class="card">
  <h2>ğŸ“ Process Call Recording</h2>
  
  <div class="tab-container">
    <button type="button" class="tab active" onclick="switchTab('file', this)">ğŸµ Upload Audio</button>
    <button type="button" class="tab" onclick="switchTab('url', this)">ğŸ”— Audio URL</button>
    <button type="button" class="tab" onclick="switchTab('transcript', this)">ğŸ“ Transcript</button>
  </div>

  <form method="post" enctype="multipart/form-data" id="callForm">
    <!-- Audio File Upload Tab -->
    <div id="file-tab" class="tab-content active">
      <div class="form-group">
        <label for="audioFile">Upload Audio File</label>
        <div class="upload-zone" id="dropZone">
          <div class="upload-icon">ğŸ™ï¸</div>
          <p><strong>Drag & drop audio file here</strong></p>
          <p style="color: #9ca3af; margin-top: 10px;">or click to browse</p>
          <p style="color: #6b7280; font-size: 14px; margin-top: 10px;">Supported: MP3, WAV, M4A, OGG (Max 50MB)</p>
          <input type="file" name="audio_file" id="audioFile" accept="audio/*" style="display: none;">
        </div>
        <div id="fileInfo" style="margin-top: 15px; display: none;">
          <p style="color: #10b981;">âœ“ File selected: <span id="fileName"></span></p>
        </div>
      </div>
    </div>

    <!-- Audio URL Tab -->
    <div id="url-tab" class="tab-content">
      <div class="form-group">
        <label for="audioUrl">Audio File URL</label>
        <input type="url" name="audio_url" id="audioUrl" placeholder="https://example.com/call-recording.mp3">
        <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">ğŸ“Œ Paste direct link to publicly accessible audio file</p>
      </div>
    </div>

    <!-- Transcript Tab -->
    <div id="transcript-tab" class="tab-content">
      <div class="form-group">
        <label for="transcript">Call Transcript</label>
        <textarea name="transcript" id="transcript" rows="6" placeholder="Paste or type the buyer-seller conversation transcript here..."></textarea>
        <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">ğŸ’¡ If you already have the transcript, paste it here</p>
      </div>
    </div>

    <div style="margin-top: 40px; border-top: 2px solid rgba(99, 102, 241, 0.1); padding-top: 30px;">
      <h3 style="margin-bottom: 20px; color: #9ca3af; font-size: 16px; font-weight: 600;">ğŸ“‹ Call Metadata (Optional)</h3>
      <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">Provide additional context about the call. All fields are optional.</p>
      
      <div class="form-group">
        <label for="metadata">Buyer & Seller Information</label>
        <textarea name="metadata" id="metadata" rows="4" placeholder="Example:
Buyer: ABC Industries, Mumbai, Maharashtra
Seller: XYZ Suppliers, Delhi
Category: Steel Rods
Call Duration: 3:45 minutes"></textarea>
      </div>
    </div>

    <div id="loadingDiv" class="loading">
      <div class="spinner"></div>
      <p>Processing your call... This may take a moment.</p>
    </div>

    <div id="messageDiv"></div>

    <button type="submit" id="submitBtn">
      <span id="btnText">ğŸš€ Process & Analyze Call</span>
    </button>
  </form>
</div>

<!-- Processing Result Section -->
<div class="card" id="resultSection" style="display: none; margin-top: 30px;">
  <h2>ğŸ“Š Processing Result</h2>
  <div id="resultContent">
    <!-- Dynamic content will be inserted here -->
  </div>
</div>

<script>
  // Tab switching - Fixed to work properly
  function switchTab(tabName, element) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding content
    if (element) {
      element.classList.add('active');
    }
    const targetTab = document.getElementById(tabName + '-tab');
    if (targetTab) {
      targetTab.classList.add('active');
    }
  }

  // Drag and drop
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('audioFile');
  const fileInfo = document.getElementById('fileInfo');
  const fileName = document.getElementById('fileName');

  dropZone.addEventListener('click', () => fileInput.click());

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      updateFileInfo(e.dataTransfer.files[0]);
    }
  });

  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) {
      updateFileInfo(e.target.files[0]);
    }
  });

  function updateFileInfo(file) {
    fileName.textContent = file.name;
    fileInfo.style.display = 'block';
  }

  // Form submission
  document.getElementById('callForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const loadingDiv = document.getElementById('loadingDiv');
    const messageDiv = document.getElementById('messageDiv');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');

    // Show loading with steps
    loadingDiv.classList.add('active');
    submitBtn.disabled = true;
    btnText.textContent = 'â³ Processing...';
    messageDiv.innerHTML = '';
    resultSection.style.display = 'none';

    // Show processing steps
    const steps = [
      'ğŸ“¤ Uploading data to server...',
      'ğŸ™ï¸ Analyzing audio/transcript...',
      'ğŸ¤– Extracting insights with AI...',
      'ğŸ“Š Generating structured output...'
    ];
    let stepIndex = 0;
    const stepInterval = setInterval(() => {
      if (stepIndex < steps.length) {
        messageDiv.innerHTML = '<div class="success-message">' + steps[stepIndex] + '</div>';
        stepIndex++;
      }
    }, 800);

    try {
      const response = await fetch('https://imworkflow.intermesh.net/webhook/buyer-seller-insight', {
        method: 'POST',
        body: formData
      });

      clearInterval(stepInterval);

      if (response.ok) {
        const result = await response.json();
        
        // Show success
        messageDiv.innerHTML = '<div class="success-message">âœ… Call processed successfully!</div>';
        
        // Display structured output
        resultSection.style.display = 'block';
        resultContent.innerHTML = `
          <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 20px;">
            <h3 style="color: #a5b4fc; margin-bottom: 15px;">ğŸ“‹ Webhook Response</h3>
            <pre style="background: rgba(13, 13, 20, 0.6); padding: 15px; border-radius: 8px; overflow-x: auto; color: #e5e7eb;">${JSON.stringify(result, null, 2)}</pre>
          </div>
          <div style="background: rgba(236, 72, 153, 0.1); padding: 20px; border-radius: 12px;">
            <h3 style="color: #f9a8d4; margin-bottom: 15px;">âœ¨ Processing Status</h3>
            <p style="color: #10b981; font-weight: 600;">âœ“ Data sent successfully to webhook</p>
            <p style="color: #9ca3af; margin-top: 10px;">The insights will be processed and available in the dashboard shortly.</p>
            <a href="/dashboard" class="button" style="margin-top: 15px; display: inline-block;">ğŸ“Š View Dashboard</a>
          </div>
        `;
        
        // Scroll to results
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        throw new Error('Server responded with ' + response.status);
      }
    } catch (error) {
      clearInterval(stepInterval);
      messageDiv.innerHTML = '<div class="error-message">âŒ Error: ' + error.message + '. Please check the webhook URL and try again.</div>';
      
      // Show error details
      resultSection.style.display = 'block';
      resultContent.innerHTML = `
        <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px;">
          <h3 style="color: #fca5a5; margin-bottom: 15px;">âš ï¸ Error Details</h3>
          <p style="color: #f87171;">${error.message}</p>
          <p style="color: #9ca3af; margin-top: 10px;">This might be due to network issues or webhook configuration. Please verify the endpoint is accessible.</p>
        </div>
      `;
    } finally {
      loadingDiv.classList.remove('active');
      submitBtn.disabled = false;
      btnText.textContent = 'ğŸš€ Process & Analyze Call';
    }
  });
</script>
{% endblock %}