{% extends 'base.html' %}
{% block content %}
<div class="hero-section">
  <h1 class="hero-title">Voice Insights from Buyer-Seller Conversations</h1>
  <p class="hero-subtitle">Upload audio calls or paste transcript to extract actionable business intelligence powered by AI</p>
</div>

<div class="card">
  <h2>ğŸ“ Process Call Recording</h2>
  
  <div class="tab-container">
    <button type="button" class="tab active" onclick="switchTab('file', this)">ğŸµ Upload Audio</button>
    <button type="button" class="tab" onclick="switchTab('url', this)">ğŸ”— Audio URL</button>
    <button type="button" class="tab" onclick="switchTab('transcript', this)">ğŸ“ Transcript</button>
  </div>

  <form method="post" enctype="multipart/form-data" id="callForm">
    <!-- Audio File Upload Tab -->
    <div id="file-tab" class="tab-content active">
      <div class="form-group">
        <label for="audioFile">Upload Audio File</label>
        <div class="upload-zone" id="dropZone">
          <div class="upload-icon">ğŸ™ï¸</div>
          <p><strong>Drag & drop audio file here</strong></p>
          <p style="color: #9ca3af; margin-top: 10px;">or click to browse</p>
          <p style="color: #6b7280; font-size: 14px; margin-top: 10px;">Supported: MP3, WAV, M4A, OGG (Max 50MB)</p>
          <input type="file" name="audio_file" id="audioFile" accept="audio/*" style="display: none;">
        </div>
        <div id="fileInfo" style="margin-top: 15px; display: none;">
          <p style="color: #10b981;">âœ“ File selected: <span id="fileName"></span></p>
        </div>
      </div>
    </div>

    <!-- Audio URL Tab -->
    <div id="url-tab" class="tab-content">
      <div class="form-group">
        <label for="audioUrl">Audio File URL</label>
        <input type="url" name="audio_url" id="audioUrl" placeholder="https://example.com/call-recording.mp3">
        <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">ğŸ“Œ Paste direct link to publicly accessible audio file</p>
      </div>
    </div>

    <!-- Transcript Tab -->
    <div id="transcript-tab" class="tab-content">
      <div class="form-group">
        <label for="transcript">Call Transcript</label>
        <textarea name="transcript" id="transcript" rows="6" placeholder="Paste or type the buyer-seller conversation transcript here..."></textarea>
        <p style="color: #9ca3af; font-size: 14px; margin-top: 8px;">ğŸ’¡ If you already have the transcript, paste it here</p>
      </div>
    </div>

    <div style="margin-top: 40px; border-top: 2px solid rgba(99, 102, 241, 0.1); padding-top: 30px;">
      <h3 style="margin-bottom: 20px; color: #9ca3af; font-size: 16px; font-weight: 600;">ğŸ“‹ Call Metadata (Optional)</h3>
      <p style="color: #6b7280; font-size: 14px; margin-bottom: 20px;">Paste tab-separated data from Excel or JSON format. Will be sent to webhook as <code>seller_buyer_meta_data</code>.</p>
      
      <div class="form-group">
        <label for="metadata">Metadata (Tab-Separated or JSON)</label>
        <textarea name="metadata" id="metadata" rows="8" placeholder="Paste values in the second row...">buyer_identifier	seller_identifier	pns_call_recording_url	mcat_id_x	mcat_name	pns_call_record_started_at	pns_call_record_ended_at	call_duration	pns_call_caller_city_id	city_name	state_name	pns_custtype_id	pns_call_modrefname	pns_call_source_modid	seller_vintage_days	pns_call_ring_duration	mcat_id_y
</textarea>
        <small style="display: block; margin-top: 8px; color: #94a3b8;">
          ğŸ’¡ Headers are pre-filled. Just paste your values in the second row.
        </small>
      </div>
    </div>

    <div id="loadingDiv" class="loading">
      <div class="spinner"></div>
      <p>Processing your call... This may take a moment.</p>
    </div>

    <div id="messageDiv"></div>

    <button type="submit" id="submitBtn">
      <span id="btnText">ğŸš€ Process & Analyze Call</span>
    </button>
  </form>
</div>

<!-- Processing Result Section -->
<div class="card" id="resultSection" style="display: none; margin-top: 30px;">
  <h2>ğŸ“Š Processing Result</h2>
  <div id="resultContent">
    <!-- Dynamic content will be inserted here -->
  </div>
</div>

<script>
  // Tab switching - Fixed to work properly
  function switchTab(tabName, element) {
    // Remove active class from all tabs and contents
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    
    // Add active class to clicked tab and corresponding content
    if (element) {
      element.classList.add('active');
    }
    const targetTab = document.getElementById(tabName + '-tab');
    if (targetTab) {
      targetTab.classList.add('active');
    }
  }

  // Drag and drop
  const dropZone = document.getElementById('dropZone');
  const fileInput = document.getElementById('audioFile');
  const fileInfo = document.getElementById('fileInfo');
  const fileName = document.getElementById('fileName');

  dropZone.addEventListener('click', () => fileInput.click());

  dropZone.addEventListener('dragover', (e) => {
    e.preventDefault();
    dropZone.classList.add('dragover');
  });

  dropZone.addEventListener('dragleave', () => {
    dropZone.classList.remove('dragover');
  });

  dropZone.addEventListener('drop', (e) => {
    e.preventDefault();
    dropZone.classList.remove('dragover');
    if (e.dataTransfer.files.length) {
      fileInput.files = e.dataTransfer.files;
      updateFileInfo(e.dataTransfer.files[0]);
    }
  });

  fileInput.addEventListener('change', (e) => {
    if (e.target.files.length) {
      updateFileInfo(e.target.files[0]);
    }
  });

  function updateFileInfo(file) {
    fileName.textContent = file.name;
    fileInfo.style.display = 'block';
  }

  // Form submission
  document.getElementById('callForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const loadingDiv = document.getElementById('loadingDiv');
    const messageDiv = document.getElementById('messageDiv');
    const submitBtn = document.getElementById('submitBtn');
    const btnText = document.getElementById('btnText');
    const resultSection = document.getElementById('resultSection');
    const resultContent = document.getElementById('resultContent');

    // Show loading with steps
    loadingDiv.classList.add('active');
    submitBtn.disabled = true;
    btnText.textContent = 'â³ Processing...';
    messageDiv.innerHTML = '';
    resultSection.style.display = 'none';

    // Show processing steps
    const steps = [
      'ğŸ“¤ Uploading data to server...',
      'ğŸ™ï¸ Analyzing audio/transcript...',
      'ğŸ¤– Extracting insights with AI...',
      'ğŸ“Š Generating structured output...'
    ];
    let stepIndex = 0;
    const stepInterval = setInterval(() => {
      if (stepIndex < steps.length) {
        messageDiv.innerHTML = '<div class="success-message">' + steps[stepIndex] + '</div>';
        stepIndex++;
      }
    }, 800);

    try {
      // Log what we're sending
      console.log('ğŸ“¤ SUBMITTING FORM TO FLASK BACKEND');
      console.log('Form data entries:');
      for (let pair of formData.entries()) {
        console.log(pair[0] + ':', pair[1]);
      }
      
      const response = await fetch('/', {
        method: 'POST',
        body: formData
      });

      clearInterval(stepInterval);

      if (response.ok) {
        const result = await response.json();
        
        console.log('âœ… RECEIVED RESPONSE FROM BACKEND:');
        console.log(JSON.stringify(result, null, 2));
        
        // Extract insights from webhook response (handle both old and new structure)
        const insights = result.webhook_response?.[0]?.output || result.webhook_response?.[0] || {};
        
        // Show success
        messageDiv.innerHTML = '<div class="success-message">âœ… Call processed successfully!</div>';
        
        // Build impressive insights dashboard
        let actionableInsights = '';
        let recommendations = [];
        
        // Note: Title changed from "ğŸš€ Actionable Insights for IndiaMART" to "Actionable Insights"
        
        // 1. BUYLEAD CONSUMED CHECK
        if (insights.urgency === 'High' && insights.buyer_intent !== 'Low') {
          actionableInsights += `
            <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #34d399;">
              <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">âœ… Active Buylead - High Priority</h4>
              <p style="margin: 0; color: #d1fae5; font-size: 14px;">Buyer Intent: <strong>${insights.buyer_intent}</strong> | Urgency: <strong>${insights.urgency}</strong></p>
              <p style="margin: 5px 0 0 0; color: #a7f3d0; font-size: 13px;">ğŸ’¡ Action: Boost this buylead for similar sellers in ${insights.location}</p>
            </div>`;
          recommendations.push('âœ“ Buylead is active and high-priority - increase visibility');
        }
        
        if (insights.no_buyer_requirement === true || insights.buyer_intent === 'Low') {
          actionableInsights += `
            <div style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #f87171;">
              <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">ğŸš« Buylead Consumed / No Requirement</h4>
              <p style="margin: 0; color: #fecaca; font-size: 14px;">Flag: <strong>buylead_consumed = true</strong></p>
              <p style="margin: 5px 0 0 0; color: #fca5a5; font-size: 13px;">ğŸ’¡ Action: Deboost this buylead, buyer already fulfilled requirement</p>
            </div>`;
          recommendations.push('âš  Mark buylead as consumed - stop sending to sellers');
        }
        
        // 2. ISQ ENRICHMENT
        let isqUpdates = '';
        if (insights.products && insights.products.length > 0) {
          insights.products.forEach((product, idx) => {
            if (product.isq && Object.keys(product.isq).length > 0) {
              const isqDetails = Object.entries(product.isq).map(([k, v]) => `${k}: <strong>${v}</strong>`).join(', ');
              isqUpdates += `
                <div style="background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 10px; border-left: 3px solid #6366f1;">
                  <p style="margin: 0 0 8px 0; color: #a5b4fc; font-weight: 600; font-size: 14px;">ğŸ“¦ ${product.product_name}</p>
                  <p style="margin: 0; color: #c7d2fe; font-size: 13px;">ISQ Captured: ${isqDetails}</p>
                  ${product.seller_quotation ? `<p style="margin: 5px 0 0 0; color: #818cf8; font-size: 13px;">ğŸ’° Price: â‚¹${product.seller_quotation.price_per_unit} per ${product.seller_quotation.unit}</p>` : ''}
                </div>`;
              recommendations.push(`âœ“ Enrich buylead with ISQ: ${Object.keys(product.isq).join(', ')}`);
            }
          });
        }
        
        if (isqUpdates) {
          actionableInsights += `
            <div style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px;">
              <h4 style="margin: 0 0 15px 0; color: white; font-size: 16px;">ğŸ¯ ISQ Enrichment Opportunities</h4>
              ${isqUpdates}
              <p style="margin: 10px 0 0 0; color: #ddd6fe; font-size: 13px;"> BL Enrichment via extracted buyer stated ISQs </p>
            </div>`;
        }
        
        // 3. SELLER INTEREST & DEALING STATUS
        if (insights.seller_interest && insights.seller_interest.includes('not')) {
          actionableInsights += `
            <div style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid #fbbf24;">
              <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">âš ï¸ Seller Not Dealing in Product</h4>
              <p style="margin: 0; color: #fef3c7; font-size: 14px;">Status: <strong>${insights.seller_interest}</strong></p>
              <p style="margin: 5px 0 0 0; color: #fde68a; font-size: 13px;">ğŸ’¡ Action: Suggest seller to update catalog or remove outdated products</p>
            </div>`;
          recommendations.push('âš  Seller catalog needs update - product no longer available');
        }
        
        // 3B. GST VALIDATION (MAIN FEATURE)
        if (result.gst_validation) {
          const gst = result.gst_validation;
          let cardColor, borderColor, iconColor, statusIcon, statusText, actionText;
          
          if (gst.validation_status === 'verified') {
            cardColor = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            borderColor = '#34d399';
            iconColor = '#d1fae5';
            statusIcon = 'âœ…';
            statusText = 'âœ… Seller is Verified GST Supplier';
            actionText = 'ğŸ’¡ Action: All products match government registration - seller is authentic';
            recommendations.push('âœ“ Seller GST verified - authentic supplier for all discussed products');
          } else if (gst.validation_status === 'partial') {
            cardColor = 'linear-gradient(135deg, #f59e0b 0%, #d97706 100%)';
            borderColor = '#fbbf24';
            iconColor = '#fef3c7';
            statusIcon = 'âš ï¸';
            statusText = 'âš ï¸ Seller Partially Verified';
            actionText = 'ğŸ’¡ Action: Some products match registration, verify non-matching items with seller';
            recommendations.push('âš  Seller GST partial match - verify non-registered products');
          } else {
            cardColor = 'linear-gradient(135deg, #ef4444 0%, #dc2626 100%)';
            borderColor = '#f87171';
            iconColor = '#fecaca';
            statusIcon = 'âŒ';
            statusText = ' Seller NOT Verified for Discussed Products';
            actionText = 'ğŸ’¡ Action: WARNING: Seller not registered for mentioned products, high fraud risk';
            recommendations.push('âš  ALERT: Seller GST unverified - products not in government registration');
          }
          
          let matchedProductsHtml = '';
          if (gst.matches && gst.matches.length > 0) {
            matchedProductsHtml = `
              <details style="margin-top: 10px; color: ${iconColor};">
                <summary style="cursor: pointer; font-size: 13px; font-weight: 600; padding: 5px 0;">âœ“ Matched Products (${gst.matches.length})</summary>
                <ul style="margin: 5px 0 0 20px; font-size: 12px; color: ${iconColor};">
                  ${gst.matches.map(p => `<li>${p}</li>`).join('')}
                </ul>
              </details>`;
          }
          
          let nonMatchedProductsHtml = '';
          if (gst.non_matches && gst.non_matches.length > 0) {
            nonMatchedProductsHtml = `
              <details style="margin-top: 10px; color: ${iconColor};">
                <summary style="cursor: pointer; font-size: 13px; font-weight: 600; padding: 5px 0;">âš  Non-Matched Products (${gst.non_matches.length})</summary>
                <ul style="margin: 5px 0 0 20px; font-size: 12px; color: ${iconColor};">
                  ${gst.non_matches.map(p => `<li>${p}</li>`).join('')}
                </ul>
              </details>`;
          }
          
          let registeredProductsHtml = '';
          if (gst.seller_data && gst.seller_data.products && gst.seller_data.products.length > 0) {
            registeredProductsHtml = `
              <details style="margin-top: 10px; color: ${iconColor};">
                <summary style="cursor: pointer; font-size: 13px; font-weight: 600; padding: 5px 0;">ğŸ“‹ Seller's Registered Products (${gst.seller_data.product_count})</summary>
                <ul style="margin: 5px 0 0 20px; font-size: 12px; color: ${iconColor}; max-height: 150px; overflow-y: auto;">
                  ${gst.seller_data.products.map(p => `<li>${p}</li>`).join('')}
                </ul>
              </details>`;
          }
          
          // Government GST Verification Details
          let governmentGstHtml = '';
          if (gst.government_gst_verification) {
            const govGst = gst.government_gst_verification;
            if (govGst.verified) {
              // Business Category Match Display
              let categoryMatchHtml = '';
              if (gst.business_category_match && gst.business_category_match.matches && gst.business_category_match.matches.length > 0) {
                const match = gst.business_category_match;
                const matchColor = match.match_score >= 50 ? '#10b981' : '#ef4444';
                const matchIcon = match.match_score >= 50 ? 'âœ…' : 'âŒ';
                const matchTextColor = match.match_score >= 50 ? '#a7f3d0' : '#fca5a5';
                
                categoryMatchHtml = `
                  <div style="background: rgba(0,0,0,0.2); padding: 10px; border-radius: 6px; margin-top: 8px; border-left: 3px solid ${matchColor};">
                    <p style="margin: 0 0 5px 0; color: white; font-size: 12px; font-weight: 600;">${matchIcon} Business Category Match: <span style="color: ${matchColor}; font-size: 14px;">${match.match_score}%</span></p>
                    ${match.matches.map(m => `
                      <p style="margin: 3px 0; color: ${matchTextColor}; font-size: 11px;">
                        âœ… ${m.category}: <strong>${m.indiamart}</strong> â†” <strong>${Array.isArray(m.government) ? m.government.join(', ') : m.government}</strong>
                      </p>
                    `).join('')}
                  </div>`;
              }
              
              governmentGstHtml = `
                <div style="background: rgba(255,255,255,0.1); padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid rgba(255,255,255,0.2);">
                  <h5 style="margin: 0 0 8px 0; color: white; font-size: 14px;">ğŸ›ï¸ Government GST Verification</h5>
                  <p style="margin: 3px 0; color: ${iconColor}; font-size: 12px;"><strong>GST Number:</strong> ${gst.seller_data.gst_number}</p>
                  ${govGst.trade_name ? `<p style="margin: 3px 0; color: ${iconColor}; font-size: 12px;"><strong>Trade Name:</strong> ${govGst.trade_name}</p>` : ''}
                  ${govGst.legal_name ? `<p style="margin: 3px 0; color: ${iconColor}; font-size: 12px;"><strong>Legal Name:</strong> ${govGst.legal_name}</p>` : ''}
                  ${govGst.constitution ? `<p style="margin: 3px 0; color: ${iconColor}; font-size: 12px;"><strong>Constitution:</strong> ${govGst.constitution}</p>` : ''}
                  ${govGst.nature_of_business && govGst.nature_of_business.length > 0 ? `<p style="margin: 3px 0; color: ${iconColor}; font-size: 12px;"><strong>Nature of Business:</strong> ${govGst.nature_of_business.join(', ')}</p>` : ''}
                  ${govGst.registration_date ? `<p style="margin: 3px 0; color: ${iconColor}; font-size: 12px;"><strong>Registration Date:</strong> ${govGst.registration_date}</p>` : ''}
                  ${govGst.status ? `<p style="margin: 3px 0; color: ${iconColor}; font-size: 12px;"><strong>Status:</strong> ${govGst.status}</p>` : ''}
                  ${categoryMatchHtml}
                  <p style="margin: 8px 0 0 0; color: #a7f3d0; font-size: 12px;">âœ… Verified by Government GST Portal</p>
                </div>`;
            } else if (gst.seller_data.gst_number) {
              governmentGstHtml = `
                <div style="background: rgba(239,68,68,0.2); padding: 12px; border-radius: 8px; margin-top: 12px; border: 1px solid rgba(239,68,68,0.3);">
                  <h5 style="margin: 0 0 8px 0; color: white; font-size: 14px;">âš ï¸ Government GST Verification Failed</h5>
                  <p style="margin: 3px 0; color: ${iconColor}; font-size: 12px;"><strong>GST Number:</strong> ${gst.seller_data.gst_number}</p>
                  <p style="margin: 8px 0 0 0; color: #fca5a5; font-size: 12px;">âŒ Could not verify with Government GST Portal</p>
                </div>`;
            }
          } else if (gst.seller_data && gst.seller_data.gst_info) {
            // Show IndiaMART GST info if government verification not available
            const gstInfo = gst.seller_data.gst_info;
            governmentGstHtml = `
              <details style="margin-top: 10px; color: ${iconColor};">
                <summary style="cursor: pointer; font-size: 13px; font-weight: 600; padding: 5px 0;">ğŸ“„ GST Information (from IndiaMART)</summary>
                <div style="margin: 8px 0 0 20px; font-size: 12px; color: ${iconColor};">
                  ${Object.entries(gstInfo).map(([key, value]) => `<p style="margin: 3px 0;"><strong>${key}:</strong> ${value}</p>`).join('')}
                </div>
              </details>`;
          }
          
          actionableInsights += `
            <div style="background: ${cardColor}; padding: 20px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid ${borderColor}; box-shadow: 0 4px 6px rgba(0,0,0,0.2);">
              <h4 style="margin: 0 0 10px 0; color: white; font-size: 16px;">${statusIcon} ${statusText}</h4>
              <p style="margin: 0; color: ${iconColor}; font-size: 14px;"><strong>${gst.message}</strong></p>
              ${gst.seller_data && gst.seller_data.company_name ? `<p style="margin: 5px 0 0 0; color: ${iconColor}; font-size: 13px;">ğŸ¢ Company: ${gst.seller_data.company_name}</p>` : ''}
              <p style="margin: 8px 0 0 0; color: ${iconColor}; font-size: 13px;">${actionText}</p>
              ${governmentGstHtml}
              ${matchedProductsHtml}
              ${nonMatchedProductsHtml}
              ${registeredProductsHtml}
            </div>`;
        }
        
        // 4. LOCATION INSIGHTS
        if (insights.location) {
          actionableInsights += `
            <div style="background: rgba(236, 72, 153, 0.15); padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 3px solid #ec4899;">
              <h4 style="margin: 0 0 8px 0; color: #f9a8d4; font-size: 14px;">ğŸ“ Location Match</h4>
              <p style="margin: 0; color: #fbcfe8; font-size: 13px;">${insights.location} - Use for geo-targeting similar buyads</p>
            </div>`;
        }
        
        // Display structured output
        resultSection.style.display = 'block';
        resultContent.innerHTML = `
          <!-- KPI METRICS -->
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 25px;">
            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.2) 0%, rgba(139, 92, 246, 0.2) 100%); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(99, 102, 241, 0.3);">
              <div style="font-size: 32px; margin-bottom: 8px;">ğŸ¯</div>
              <div style="font-size: 24px; font-weight: bold; color: #a5b4fc; margin-bottom: 5px;">${insights.buyer_intent || 'N/A'}</div>
              <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 1px;">Buyer Intent</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.2) 0%, rgba(219, 39, 119, 0.2) 100%); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(236, 72, 153, 0.3);">
              <div style="font-size: 32px; margin-bottom: 8px;">âš¡</div>
              <div style="font-size: 24px; font-weight: bold; color: #f9a8d4; margin-bottom: 5px;">${insights.urgency || 'N/A'}</div>
              <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 1px;">Urgency Level</div>
            </div>
            <div style="background: linear-gradient(135deg, rgba(34, 197, 94, 0.2) 0%, rgba(22, 163, 74, 0.2) 100%); padding: 20px; border-radius: 12px; text-align: center; border: 1px solid rgba(34, 197, 94, 0.3);">
              <div style="font-size: 32px; margin-bottom: 8px;">ğŸ¤</div>
              <div style="font-size: 14px; font-weight: bold; color: #86efac; margin-bottom: 5px;">${insights.seller_interest || 'Unknown'}</div>
              <div style="font-size: 12px; color: #9ca3af; text-transform: uppercase; letter-spacing: 1px;">Seller Interest</div>
            </div>
          </div>
          
          <!-- ACTIONABLE INSIGHTS -->
          <div style="margin-bottom: 25px;">
            <h3 style="color: #a5b4fc; margin-bottom: 15px; font-size: 18px;">ï¿½ Actionable Insights for IndiaMART</h3>
            ${actionableInsights || '<p style="color: #6b7280;">No specific action items detected.</p>'}
          </div>
          
          <!-- RECOMMENDATIONS -->
          ${recommendations.length > 0 ? `
            <div style="background: rgba(99, 102, 241, 0.1); padding: 20px; border-radius: 12px; margin-bottom: 25px;">
              <h3 style="color: #a5b4fc; margin: 0 0 15px 0; font-size: 16px;">ğŸ’¡ Platform Recommendations</h3>
              ${recommendations.map(rec => `<div style="color: #c7d2fe; font-size: 14px; margin-bottom: 8px; padding-left: 10px; border-left: 3px solid #6366f1;">${rec}</div>`).join('')}
            </div>
          ` : ''}
          
          <!-- CALL SUMMARY -->
          ${insights.short_summary ? `
            <div style="background: linear-gradient(135deg, rgba(13, 13, 20, 0.6) 0%, rgba(30, 30, 40, 0.6) 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(99, 102, 241, 0.2);">
              <h3 style="color: #f9a8d4; margin: 0 0 15px 0; font-size: 16px;">ğŸ“ Call Summary</h3>
              <div style="color: #e5e7eb; font-size: 14px; line-height: 1.6; white-space: pre-line;">${insights.short_summary}</div>
            </div>
          ` : ''}
          
          <!-- SELLER CALL SUMMARY (NEW STRUCTURE) -->
          ${insights.seller_call_summary ? `
            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.12) 0%, rgba(139, 92, 246, 0.12) 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(99, 102, 241, 0.25);">
              <h3 style="color: #a5b4fc; margin: 0 0 15px 0; font-size: 16px;">ğŸ“Š Detailed Call Analysis</h3>
              
              ${insights.seller_call_summary.conversion_outlook ? `
                <div style="background: rgba(34, 197, 94, 0.15); padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 3px solid #22c55e;">
                  <h4 style="color: #86efac; margin: 0 0 8px 0; font-size: 14px;">ğŸ¯ Conversion Outlook</h4>
                  <p style="color: #d1fae5; font-size: 13px; margin: 0; line-height: 1.6;">${insights.seller_call_summary.conversion_outlook}</p>
                </div>
              ` : ''}
              
              ${insights.seller_call_summary.key_points && insights.seller_call_summary.key_points.length > 0 ? `
                <div style="background: rgba(99, 102, 241, 0.1); padding: 15px; border-radius: 8px;">
                  <h4 style="color: #c7d2fe; margin: 0 0 12px 0; font-size: 14px;">ğŸ”‘ Key Points</h4>
                  ${insights.seller_call_summary.key_points.map(point => `
                    <div style="color: #e0e7ff; font-size: 13px; line-height: 1.7; margin-bottom: 8px; padding-left: 15px; border-left: 2px solid #818cf8;">â€¢ ${point}</div>
                  `).join('')}
                </div>
              ` : ''}
            </div>
          ` : ''}
          
          <!-- AI SUGGESTED NUDGES (NEW STRUCTURE) -->
          ${insights.ai_suggested_nudges && insights.ai_suggested_nudges.length > 0 ? `
            <div style="background: linear-gradient(135deg, rgba(236, 72, 153, 0.15) 0%, rgba(219, 39, 119, 0.15) 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(236, 72, 153, 0.3);">
              <h3 style="color: #f9a8d4; margin: 0 0 15px 0; font-size: 16px;">ğŸ’¡ AI-Suggested Nudges</h3>
              <div style="display: grid; gap: 12px;">
                ${insights.ai_suggested_nudges.map(nudge => `
                  <div style="background: rgba(0, 0, 0, 0.2); padding: 15px; border-radius: 8px; border-left: 3px solid #ec4899;">
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 6px;">
                      <span style="background: #ec4899; color: white; padding: 4px 10px; border-radius: 12px; font-size: 11px; font-weight: 600; text-transform: uppercase;">${nudge.nudge_type}</span>
                    </div>
                    <p style="color: #fecdd3; font-size: 14px; margin: 0; line-height: 1.6;">${nudge.nudge_text}</p>
                  </div>
                `).join('')}
              </div>
            </div>
          ` : ''}
          
          <!-- AI SUGGESTIONS (OLD STRUCTURE - FALLBACK) -->
          ${insights.ai_suggestion && !insights.ai_suggested_nudges ? `
            <div style="background: linear-gradient(135deg, rgba(99, 102, 241, 0.15) 0%, rgba(139, 92, 246, 0.15) 100%); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(99, 102, 241, 0.3);">
              <h3 style="color: #a5b4fc; margin: 0 0 15px 0; font-size: 16px;">ğŸ¤– AI Suggestions</h3>
              ${typeof insights.ai_suggestion === 'string' ? 
                `<div style="color: #c7d2fe; font-size: 14px; line-height: 1.8; white-space: pre-line;">${insights.ai_suggestion}</div>` : 
                insights.ai_suggestion.map(suggestion => `
                  <div style="color: #c7d2fe; font-size: 14px; line-height: 1.6; margin-bottom: 10px; padding-left: 15px; border-left: 3px solid #6366f1;">â€¢ ${suggestion}</div>
                `).join('')
              }
            </div>
          ` : ''}
          
          <!-- RAW OUTPUT (Collapsible) -->
          <details style="background: rgba(13, 13, 20, 0.4); padding: 15px; border-radius: 12px; border: 1px solid rgba(99, 102, 241, 0.1);">
            <summary style="color: #9ca3af; cursor: pointer; font-weight: 600; font-size: 14px; user-select: none;">ğŸ” View Full JSON Response</summary>
            <pre style="background: rgba(0, 0, 0, 0.3); padding: 15px; border-radius: 8px; overflow-x: auto; color: #e5e7eb; margin-top: 15px; font-size: 12px;">${JSON.stringify(result, null, 2)}</pre>
          </details>
        `;
        
        // Scroll to results
        resultSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
      } else {
        const errorData = await response.json().catch(() => ({}));
        console.error('âŒ ERROR RESPONSE:', errorData);
        throw new Error(errorData.error || 'Server responded with ' + response.status);
      }
    } catch (error) {
      console.error('âŒ FETCH ERROR:', error);
      clearInterval(stepInterval);
      messageDiv.innerHTML = '<div class="error-message">âŒ Error: ' + error.message + '</div>';
      
      // Show error details
      resultSection.style.display = 'block';
      resultContent.innerHTML = `
        <div style="background: rgba(239, 68, 68, 0.1); padding: 20px; border-radius: 12px;">
          <h3 style="color: #fca5a5; margin-bottom: 15px;">âš ï¸ Error Details</h3>
          <p style="color: #f87171;">${error.message}</p>
          <p style="color: #9ca3af; margin-top: 10px; font-size: 14px;">Check browser console (F12) and terminal for detailed logs.</p>
        </div>
      `;
    } finally {
      loadingDiv.classList.remove('active');
      submitBtn.disabled = false;
      btnText.textContent = 'ğŸš€ Process & Analyze Call';
    }
  });
</script>
{% endblock %}